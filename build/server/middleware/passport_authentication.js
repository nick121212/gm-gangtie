var http=require("http"),Promise=require("bluebird"),app=require("../server"),url=require("url");module.exports=function(){function a(a){return new Promise(function(b,c){var d,e={hostname:"pt.p7game.com",port:80,path:"/api/v1/get_user?access_token="+a,method:"GET",timeout:2},f=[],g=http.request(e,function(a){a.setEncoding("utf8"),a.on("data",function(a){f.push(a)}),a.on("end",function(){var a=JSON.parse(f.join(""));1!==a.result_code?(d=new Error(a.message||"登录状态已经过期,请重新登录!"),d.status=403,c(d)):b(a)})});g.on("error",c),g.end()})}return function(b,c,d){var e,f=url.parse(b.path),g=f.pathname.lastIndexOf(".");if("/"===f.pathname)return void d();switch(f.pathname.substring(g+1)){case"js":case"ts":case"map":case"css":case"html":case"png":case"ico":case"jpg":case"manifest":return void d()}app.models.person.findOne({where:{userToken:b.query.user_token}}).then(function(c){return null==c?(e=new Error("此账号没有权限!"),void d(e)):void a(b.query.access_token).then(function(a){d(null,a)},d)},d)}};