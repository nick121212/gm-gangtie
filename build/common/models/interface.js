function executeCommand(a,b,c,d){return new Promise(function(e,f){var g,h,i,j,k={access_token:d.query.access_token,user_token:d.query.user_token},l={query:k,method:b.type,timeout:5e3};switch(b.params&&(h=b.params.split(","),c.pageCount&&(c.per_page=c.pageCount),_.forEach(h,function(a){pd=null,_.forEach(a.split("."),function(b){return a=b,pd?pd=pd[b]:pd=c[b],pd?void 0:!1}),pd&&(k[a]=pd)})),g=b.baseUrl?"http://"+b.baseUrl+":"+(b.port||80)+b["interface"]:a.serProtocol+"://"+a.serAddress+":"+(a.serPort||80)+b["interface"],l.query.sign=md5(g+gm_secret),console.log("options:",l),console.log("data:",c),console.log("model:",b),console.log("server:",a),console.log("uri:",g),console.log("gm_secret:",gm_secret),b.type.toLowerCase()){case"get":i=rest.get(g,l);break;case"post":i=rest.postJson(g,b.clearData?null:c,l)}i.on("success",function(a){try{a=JSON.parse(a)}catch(g){}if(console.log("result:",a),"error"===a.result)return j=new Error(a.msg),j.status=400,void f(j);if(a.data&&"/api/export_used_gift_codes"===b["interface"]){var h=(new Date).getTime().toString();return void fs.writeFile(path.join("gifts",h),a.data,function(b){return b?(b.status=400,f(b)):(a.url="/export_gift?user_token="+d.query.user_token+"&access_token="+d.query.access_token+"&name="+c.title+"&filename="+h,void e(a))})}e(a)}).on("error",f).on("timeout",function(a){j=new Error("调用接口超时:"+a),j.status=400,f(j)})})}var async=require("async"),Promise=require("bluebird"),_=require("lodash"),rest=require("restler"),fs=require("fs"),path=require("path"),app=require("../../server/server"),md5=require("blueimp-md5"),gm_secret="6db16ea48786f83c65750dd438bfe009";module.exports=function(a){a.execute=function(b,c,d,e){var f;async.auto({model:function(b){a.findOne({where:{interfaceId:d}},b)},server:function(a){return console.log("data-origin",c),c&&c.change_server?void a(null,c.change_server):void app.models.server.findOne({where:{isDefault:!0}},a)},execute:["model","server",function(a,d){d.model?executeCommand(d.server,d.model,c,b).then(function(b){a(null,b)},a):(f=new Error("没有找到接口!"),f.status=400)}]},function(a,b){return a?void e(a):void e(null,b.execute)})},a.remoteMethod("execute",{accepts:[{arg:"req",type:"object",http:{source:"req"}},{arg:"data",type:"object",http:{source:"body"}},{arg:"id",type:"number",required:!0}],returns:{root:!0,type:"object"},http:{verb:"post",path:"/:id/execute"}})};